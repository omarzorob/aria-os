version: "3.9"

# ============================================================================
# Aria OS â€” Docker Compose
#
# Usage:
#   docker compose -f docker/docker-compose.yml up --build
#
# NOTE: For Android device access in Docker, pass --device /dev/bus/usb or
#       use ADB over WiFi: set ANDROID_SERIAL=<ip>:5555 and connect via ADB.
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Aria Agent Server
  # --------------------------------------------------------------------------
  aria-agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: aria-os/agent:latest
    container_name: aria-agent

    # Load secrets from .env (never commit this file)
    env_file:
      - ../.env

    environment:
      - ARIA_HOST=0.0.0.0
      - ARIA_PORT=8765
      - PYTHONUNBUFFERED=1

    ports:
      - "8765:8765"

    volumes:
      # Persistent session memory
      - aria-memory:/app/memory
      # Optional: mount ADB keys from host for device auth
      # - ${HOME}/.android:/root/.android:ro

    # For USB-connected Android devices, uncomment:
    # devices:
    #   - /dev/bus/usb:/dev/bus/usb

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    networks:
      - aria-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ----------------------------------------------------------------------------
# Volumes
# ----------------------------------------------------------------------------
volumes:
  aria-memory:
    driver: local

# ----------------------------------------------------------------------------
# Networks
# ----------------------------------------------------------------------------
networks:
  aria-network:
    driver: bridge
